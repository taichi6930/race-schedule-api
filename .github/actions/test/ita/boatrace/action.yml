name: "ITa Test"
description: "Run ITa tests"

runs:
  using: "composite"
  steps:
    - name: Check out the repository
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install
      shell: bash

    # サーバーが起動したらcurlを叩く
    - name: Start server in background
      run: |
        bun run start:local:no_data &  # サーバーをバックグラウンドで起動
        for i in {1..5}; do
          curl --silent --head http://localhost:3000/health && break
          echo "Waiting for server to start..."
          sleep 10
        done
      shell: bash

    - name: Curl API for Boatrace Place
      run: |
        # Initial GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:3000/api/races/all/place?startDate=2024-10-01&finishDate=2024-10-31&raceType=boatrace' \
          -H 'accept: application/json')

        # Initial GET Response Check
        boatrace_items=$(echo "$response" | jq 'if type=="object" and has("BOATRACE") then .BOATRACE else . end')
        if [[ "$boatrace_items" != "[]" ]]; then
          echo "❌ Initial GET request failed. Expected [], but got $response"
          exit 1
        fi

        # POST request
        post_response=$(curl -s -o /dev/null -w "%{http_code}" -X 'POST' \
          'http://localhost:3000/api/races/all/place' \
          -H 'accept: */*' \
          -H 'Content-Type: application/json' \
          -d '{
                "startDate": "2024-10-01",
                "finishDate": "2024-10-31",
                "raceType": ["boatrace"]
              }')

        # POST Response Check
        if [[ "$post_response" != "200" ]]; then
          echo "❌ POST request failed with status code $post_response"
          exit 1
        fi

        # Updated GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:3000/api/races/all/place?startDate=2024-10-01&finishDate=2024-10-31&raceType=boatrace' \
          -H 'accept: application/json')

        # Final GET Response Check: boatraceキーのみ抜き出して要素数が31個であることを確認
        item_count=$(echo "$response" | jq 'if type=="object" and has("BOATRACE") then .BOATRACE | length else length end')
        if [[ "$item_count" -ne 31 ]]; then
          echo "❌ Updated GET request failed. Expected 31 items but got $item_count items."
          exit 1
        fi

        echo "✅ All checks passed successfully."
      shell: bash

    - name: Curl API for Boatrace Race
      run: |
        # Initial GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:3000/api/races/all/race?startDate=2024-10-01&finishDate=2024-11-01&raceType=boatrace' \
          -H 'accept: application/json')

        # Initial GET Response Check
        boatrace_items=$(echo "$response" | jq 'if type=="object" and has("BOATRACE") then .BOATRACE else . end')
        if [[ "$boatrace_items" != "[]" ]]; then
          echo "❌ Initial GET request failed. Expected [], but got $response"
          exit 1
        fi

        # POST request
        post_response=$(curl -s -o /dev/null -w "%{http_code}" -X 'POST' \
          'http://localhost:3000/api/races/all/race' \
          -H 'accept: */*' \
          -H 'Content-Type: application/json' \
          -d '{
                "startDate": "2024-10-01",
                "finishDate": "2024-11-01",
                "raceType": ["boatrace"]
              }')

        # POST Response Check
        if [[ "$post_response" != "200" ]]; then
          echo "❌ POST request failed with status code $post_response"
          exit 1
        fi

        # Updated GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:3000/api/races/all/race?startDate=2024-10-01&finishDate=2024-11-01&raceType=boatrace' \
          -H 'accept: application/json')

        # Final GET Response Check: boatraceキーのみ抜き出して要素数が372個であることを確認
        item_count=$(echo "$response" | jq 'if type=="object" and has("BOATRACE") then .BOATRACE | length else length end')
        if [[ "$item_count" -ne 372 ]]; then
          echo "❌ Updated GET request failed. Expected 372 items but got $item_count items."
          exit 1
        fi

        echo "✅ All checks passed successfully."
      shell: bash

    - name: Curl API for Boatrace Calendar
      run: |
        # Initial GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:3000/api/races/all/calendar?startDate=2024-10-01&finishDate=2024-11-01&raceType=boatrace' \
          -H 'accept: application/json')

        # Initial GET Response Check
        boatrace_items=$(echo "$response" | jq 'if type=="object" and has("BOATRACE") then .BOATRACE else . end')
        if [[ "$boatrace_items" != "[]" ]]; then
          echo "❌ Initial GET request failed. Expected [], but got $response"
          exit 1
        fi

        # POST request
        post_response=$(curl -s -o /dev/null -w "%{http_code}" -X 'POST' \
          'http://localhost:3000/api/races/all/calendar' \
          -H 'accept: */*' \
          -H 'Content-Type: application/json' \
          -d '{
                "startDate": "2024-10-01",
                "finishDate": "2024-11-01",
                "raceType": ["boatrace"]
              }')

        # POST Response Check
        if [[ "$post_response" != "200" ]]; then
          echo "❌ POST request failed with status code $post_response"
          exit 1
        fi

        # Updated GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:3000/api/races/all/calendar?startDate=2024-10-01&finishDate=2024-11-01&raceType=boatrace' \
          -H 'accept: application/json')

        # Final GET Response Check: boatraceキーのみ抜き出して要素数が31個であることを確認
        item_count=$(echo "$response" | jq 'if type=="object" and has("BOATRACE") then .BOATRACE | length else length end')
        if [[ "$item_count" -ne 31 ]]; then
          echo "❌ Updated GET request failed. Expected 31 items but got $item_count items."
          exit 1
        fi

        echo "✅ All checks passed successfully."
      shell: bash
