name: "ITa Test (Cloudflare)"
description: "Run ITa tests against Cloudflare worker (incremental: install deps)"

runs:
  using: "composite"
  steps:
    - name: Check out the repository
      uses: actions/checkout@v4

    - name: Set up Node.js 24
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Set up pnpm
      uses: pnpm/action-setup@v2
      with:
        version: '9.10.0'

    - name: Install dependencies
      run: pnpm install
      shell: bash

    - name: Create wrangler.toml (temp)
      run: |
        printf '%s
        ' "name = \"race-schedule-local\"" \
          "main = \"./src/index.ts\"" \
          "compatibility_date = \"2025-01-01\"" \
          "# enable Node.js built-in module compatibility (path, stream, etc.) for local dev" \
          "compatibility_flags = [\"nodejs_compat\"]" \
          "" \
          "[vars]" \
          "ENV = \"GITHUB_ACTIONS_CI\"" \
          "" \
          "[env.development]" \
          "main = \"./src/index.ts\"" \
          "compatibility_date = \"2025-01-01\"" \
          "compatibility_flags = [\"nodejs_compat\"]" \
          "" \
          "[env.development.vars]" \
          "ENV = \"GITHUB_ACTIONS_CI\"" \
          "" \
          "# D1 database binding for development environment" \
          "[[env.development.d1_databases]]" \
          "binding = \"MY_DB\"" \
          "database_name = \"my-database\"" \
          "database_id = \"my-database\"" \
          "" \
          "[[d1_databases]]" \
          "binding = \"MY_DB\"" \
          "database_name = \"my-database\"" \
          "# For wrangler config, d1 database bindings require a database_id field" \
          "database_id = \"my-database\"" > wrangler.toml
      shell: bash

    - name: Apply D1 migrations (local)
      run: |
        # run migrations locally; if no migrations exist this will still exit zero in many setups
        pnpm run wrangler:d1:migrations:apply:local || true
      shell: bash

    - name: Debug .env and runner ENV (temp)
      run: |
        echo "Listing .env file (if present):"
        ls -la .env || true
        echo "--- .env contents ---"
        sed -n '1,200p' .env || true
        echo "--- node process.env.ENV (from runner) ---"
        node -e "console.log(process.env.ENV || '')" || true
        echo "--- shell export and printenv check ---"
        export ENV=GITHUB_ACTIONS_CI
        echo "exported ENV=$ENV"
        printenv | grep -i '^ENV=' || true
      shell: bash

    - name: Create .env (temp)
      run: |
        printf '%s
        ' "ENV=GITHUB_ACTIONS_CI" > .env
      shell: bash

    - name: Start wrangler dev in background and wait for /health
      run: |
        # set ENV expected by the worker and start wrangler in local mode
        export ENV=GITHUB_ACTIONS_CI
        echo "Starting wrangler dev (logs -> wrangler.log)"
        TZ=Asia/Tokyo pnpm run dev:cloudflare:local > wrangler.log 2>&1 &
        echo $! > wrangler.pid

        # wait for health endpoint with extended timeout and process liveness checks
        started=false
        for i in {1..60}; do
          if curl --silent --head http://localhost:8787/health >/dev/null 2>&1; then
            started=true
            break
          fi
          # check process is still running
          if [ -s wrangler.pid ] && ! kill -0 "$(cat wrangler.pid)" >/dev/null 2>&1; then
            echo "wrangler dev process exited unexpectedly. Dumping last 200 lines of wrangler.log:"
            tail -n 200 wrangler.log || true
            exit 1
          fi
          echo "Waiting for wrangler dev to start... ($i)"
          sleep 5
        done

        if [ "$started" != true ]; then
          echo "Timed out waiting for /health. Dumping last 400 lines of wrangler.log:"
          tail -n 400 wrangler.log || true
          echo "Contents of wrangler.pid:"; cat wrangler.pid || true
          exit 1
        fi
      shell: bash

    - name: Simple health check
      run: |
        if ! curl -sS --fail http://localhost:8787/health; then
          echo "Health check failed. Dumping wrangler.log (last 400 lines):"
          tail -n 400 wrangler.log || true
          echo "Contents of wrangler.pid:"; cat wrangler.pid || true
          exit 1
        fi
      shell: bash

    - name: Curl API for Overseas Race
      run: |
        BASE=http://localhost:8787

        # Initial GET request (capture body + status)
        resp=$(curl -s -w "\n%{http_code}" -X 'GET' "${BASE}/race?startDate=2024-10-01&finishDate=2024-11-01&raceType=OVERSEAS" -H 'accept: application/json')
        http_code=$(printf "%s\n" "$resp" | tail -n1)
        body=$(printf "%s\n" "$resp" | sed '$d')

        echo "Initial GET status: $http_code"
        if [[ "$http_code" -ne 200 ]]; then
          echo "❌ Initial GET failed with status $http_code. Body:"
          printf '%s\n' "$body"
          exit 1
        fi

        # Validate JSON before using jq
        echo "$body" | jq -e . >/dev/null 2>&1 || { echo "❌ Initial GET returned non-JSON: $body"; exit 1; }

        # Initial GET Response Check
        overseas_items=$(echo "$body" | jq -c 'if type=="object" and has("OVERSEAS") then .OVERSEAS else . end')
        if [[ "$overseas_items" != "[]" ]]; then
          echo "❌ Initial GET request failed. Expected [], but got $overseas_items"
          exit 1
        fi

        # POST request
        post_response=$(curl -s -o /dev/null -w "%{http_code}" -X 'POST' "${BASE}/race" -H 'accept: */*' -H 'Content-Type: application/json' -d '{"startDate":"2024-10-01","finishDate":"2024-11-01","raceType":["OVERSEAS"]}')

        # POST Response Check
        if [[ "$post_response" != "200" ]]; then
          echo "❌ POST request failed with status code $post_response"
          exit 1
        fi

        # Updated GET request (capture body + status)
        resp=$(curl -s -w "\n%{http_code}" -X 'GET' "${BASE}/race?startDate=2024-10-01&finishDate=2024-11-01&raceType=OVERSEAS" -H 'accept: application/json')
        http_code=$(printf "%s\n" "$resp" | tail -n1)
        body=$(printf "%s\n" "$resp" | sed '$d')

        echo "Updated GET status: $http_code"
        if [[ "$http_code" -ne 200 ]]; then
          echo "❌ Updated GET failed with status $http_code. Body:"
          printf '%s\n' "$body"
          exit 1
        fi

        # Validate JSON before using jq
        echo "$body" | jq -e . >/dev/null 2>&1 || { echo "❌ Updated GET returned non-JSON: $body"; exit 1; }

        # Final GET Response Check: 要素数が372個であることを確認
        item_count=$(echo "$body" | jq 'if type=="object" and has("OVERSEAS") then .OVERSEAS | length else length end')
        if [[ "$item_count" -ne 372 ]]; then
          echo "❌ Updated GET request failed. Expected 372 items but got $item_count items."
          exit 1
        fi

        echo "✅ Overseas Race checks passed successfully."
      shell: bash

    - name: Curl API for Overseas Calendar
      run: |
        BASE=http://localhost:8787

        # Initial GET request (capture body + status)
        resp=$(curl -s -w "\n%{http_code}" -X 'GET' "${BASE}/calendar?startDate=2024-10-01&finishDate=2024-11-01&raceType=OVERSEAS" -H 'accept: application/json')
        http_code=$(printf "%s\n" "$resp" | tail -n1)
        body=$(printf "%s\n" "$resp" | sed '$d')

        echo "Initial GET status: $http_code"
        if [[ "$http_code" -ne 200 ]]; then
          echo "❌ Initial GET failed with status $http_code. Body:"
          printf '%s\n' "$body"
          exit 1
        fi

        # Validate JSON before using jq
        echo "$body" | jq -e . >/dev/null 2>&1 || { echo "❌ Initial GET returned non-JSON: $body"; exit 1; }

        # Initial GET Response Check
        overseas_items=$(echo "$body" | jq -c 'if type=="object" and has("OVERSEAS") then .OVERSEAS else . end')
        if [[ "$overseas_items" != "[]" ]]; then
          echo "❌ Initial GET request failed. Expected [], but got $overseas_items"
          exit 1
        fi

        # POST request
        post_response=$(curl -s -o /dev/null -w "%{http_code}" -X 'POST' "${BASE}/calendar" -H 'accept: */*' -H 'Content-Type: application/json' -d '{"startDate":"2024-10-01","finishDate":"2024-11-01","raceType":["OVERSEAS"]}')

        # POST Response Check
        if [[ "$post_response" != "200" ]]; then
          echo "❌ POST request failed with status code $post_response"
          exit 1
        fi

        # Updated GET request (capture body + status)
        resp=$(curl -s -w "\n%{http_code}" -X 'GET' "${BASE}/calendar?startDate=2024-10-01&finishDate=2024-11-01&raceType=OVERSEAS" -H 'accept: application/json')
        http_code=$(printf "%s\n" "$resp" | tail -n1)
        body=$(printf "%s\n" "$resp" | sed '$d')

        echo "Updated GET status: $http_code"
        if [[ "$http_code" -ne 200 ]]; then
          echo "❌ Updated GET failed with status $http_code. Body:"
          printf '%s\n' "$body"
          exit 1
        fi

        # Validate JSON before using jq
        echo "$body" | jq -e . >/dev/null 2>&1 || { echo "❌ Updated GET returned non-JSON: $body"; exit 1; }

        # Final GET Response Check: 要素数が372個であることを確認
        item_count=$(echo "$body" | jq 'if type=="object" and has("OVERSEAS") then .OVERSEAS | length else length end')
        if [[ "$item_count" -ne 372 ]]; then
          echo "❌ Updated GET request failed. Expected 372 items but got $item_count items."
          exit 1
        fi

        echo "✅ Overseas Calendar checks passed successfully."
      shell: bash

    # Next steps (to add later): create wrangler.toml, run D1 migrations, start wrangler dev, run curl tests
