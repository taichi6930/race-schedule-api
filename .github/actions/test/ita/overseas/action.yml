name: "ITa Test"
description: "Run ITa tests"

runs:
  using: "composite"
  steps:
    - name: Check out the repository
      uses: actions/checkout@v4

    - name: Set up pnpm
      uses: pnpm/action-setup@v2
      with:
        version: '9.10.0'

    - name: Install dependencies
      run: pnpm install
      shell: bash

    # サーバーが起動したらcurlを叩く
    - name: Prepare local D1 and start Cloudflare Workers in background
      run: |
        # Apply local D1 migrations so the worker has the DB available
        pnpm run wrangler:d1:migrations:apply:local

        # Start wrangler dev (Cloudflare Workers local) in background
        # dev:cloudflare:local uses wrangler dev --env development --local
        pnpm run dev:cloudflare:local &

        # Wait for worker to be ready on port 8787
        for i in {1..10}; do
          curl --silent --head http://localhost:8787/health && break
          echo "Waiting for worker to start..."
          sleep 5
        done
      shell: bash

    - name: Curl API for Overseas Race
      run: |
        # Initial GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:8787/race?startDate=2024-10-01&finishDate=2024-11-01&raceType=OVERSEAS' \
          -H 'accept: application/json')

        # Initial GET Response Check
        overseas_items=$(echo "$response" | jq 'if type=="object" and has("OVERSEAS") then .OVERSEAS else . end')
        if [[ "$overseas_items" != "[]" ]]; then
          echo "❌ Initial GET request failed. Expected [], but got $response"
          exit 1
        fi

        # POST request
        post_response=$(curl -s -o /dev/null -w "%{http_code}" -X 'POST' \
          'http://localhost:8787/race' \
          -H 'accept: */*' \
          -H 'Content-Type: application/json' \
          -d '{
                "startDate": "2024-10-01",
                "finishDate": "2024-11-01",
                "raceType": ["OVERSEAS"]
              }')

        # POST Response Check
        if [[ "$post_response" != "200" ]]; then
          echo "❌ POST request failed with status code $post_response"
          exit 1
        fi

        # Updated GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:8787/api/race?startDate=2024-10-01&finishDate=2024-11-01&raceType=OVERSEAS' \
          -H 'accept: application/json')

        # Final GET Response Check: 要素数が372個であることを確認
        item_count=$(echo "$response" | jq 'if type=="object" and has("OVERSEAS") then .OVERSEAS | length else length end')
        if [[ "$item_count" -ne 372 ]]; then
          echo "❌ Updated GET request failed. Expected 372 items but got $item_count items."
          exit 1
        fi

        echo "✅ All checks passed successfully."
      shell: bash

    - name: Curl API for Overseas Calendar
      run: |
        # Initial GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:8787/calendar?startDate=2024-10-01&finishDate=2024-11-01&raceType=OVERSEAS' \
          -H 'accept: application/json')

        # Initial GET Response Check
        overseas_items=$(echo "$response" | jq 'if type=="object" and has("OVERSEAS") then .OVERSEAS else . end')
        if [[ "$overseas_items" != "[]" ]]; then
          echo "❌ Initial GET request failed. Expected [], but got $response"
          exit 1
        fi

        # POST request
        post_response=$(curl -s -o /dev/null -w "%{http_code}" -X 'POST' \
          'http://localhost:8787/calendar' \
          -H 'accept: */*' \
          -H 'Content-Type: application/json' \
          -d '{
                "startDate": "2024-10-01",
                "finishDate": "2024-11-01",
                "raceType": ["OVERSEAS"]
              }')

        # POST Response Check
        if [[ "$post_response" != "200" ]]; then
          echo "❌ POST request failed with status code $post_response"
          exit 1
        fi

        # Updated GET request
        response=$(curl -s -X 'GET' \
          'http://localhost:8787/api/races/all/calendar?startDate=2024-10-01&finishDate=2024-11-01&raceType=OVERSEAS' \
          -H 'accept: application/json')

        # Final GET Response Check: 要素数が372個であることを確認
        item_count=$(echo "$response" | jq 'if type=="object" and has("OVERSEAS") then .OVERSEAS | length else length end')
        if [[ "$item_count" -ne 372 ]]; then
          echo "❌ Updated GET request failed. Expected 372 items but got $item_count items."
          exit 1
        fi

        echo "✅ All checks passed successfully."
      shell: bash
