name: Deploy DB to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  check-db-changes:
    runs-on: ubuntu-latest
    outputs:
      db_changed: ${{ steps.check.outputs.changed }}
      previous_tag: ${{ steps.get-tags.outputs.previous_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: get-tags
        run: |
          # ç¾åœ¨ã®ã‚¿ã‚°ã‚’å–å¾—
          current_tag=${GITHUB_REF#refs/tags/}
          echo "current_tag=$current_tag"
          
          # å‰ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆç¾åœ¨ã®ã‚¿ã‚°ã®1ã¤å‰ï¼‰
          previous_tag=$(git tag --sort=-v:refname | grep -A1 "^${current_tag}$" | tail -n1)
          
          if [ -z "$previous_tag" ]; then
            echo "No previous tag found, checking all changes"
            previous_tag=""
          else
            echo "Previous tag: $previous_tag"
          fi
          
          echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT

      - name: Check for DB changes since previous tag
        id: check
        run: |
          previous_tag="${{ steps.get-tags.outputs.previous_tag }}"
          
          if [ -z "$previous_tag" ]; then
            # å‰ã®ã‚¿ã‚°ãŒãªã„å ´åˆã¯å¤‰æ›´ã‚ã‚Šã¨ã™ã‚‹
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "No previous tag - treating as changed"
          else
            # å‰ã®ã‚¿ã‚°ã‹ã‚‰ç¾åœ¨ã®ã‚¿ã‚°ã¾ã§ã® packages/db/ é…ä¸‹ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
            if git diff --name-only "$previous_tag" HEAD | grep -q "^packages/db/"; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "DB changes detected"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "No DB changes detected"
            fi
          fi

  deploy-production:
    needs: check-db-changes
    if: needs.check-db-changes.outputs.db_changed == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Deploy migrations to Production
        working-directory: packages/db
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸš€ Deploying DB migrations to production environment..."
          echo "âš ï¸  This is a PRODUCTION deployment!"
          pnpm run migrations:apply:production
          echo "âœ… Production deployment completed"

      - name: List applied migrations
        working-directory: packages/db
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ“‹ Applied migrations in production:"
          pnpm run migrations:list:production

      - name: Create deployment summary
        run: |
          echo "## ðŸŽ‰ Production DB Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Tag:** ${{ needs.check-db-changes.outputs.previous_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "DB migrations have been successfully applied to production." >> $GITHUB_STEP_SUMMARY
